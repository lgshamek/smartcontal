,h'<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libro Diario - martconta</title>
<style>
body{font-family:"Segoe UI",Arial,sans-serif;background:#f4f6f9;margin:0;padding:20px;color:#222}
.card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:16px;max-width:1200px;margin:auto}
h2{margin-top:0;color:#1e293b;text-align:center}
table{border-collapse:collapse;width:100%;font-size:10.5px;margin-top:10px}
th,td{border:1px solid #ccc;padding:4px 6px;text-align:left}
th{background:#f1f5f9}
.right{text-align:right}
tfoot td{font-weight:bold;border-top:2px solid #888;background:#f8fafc}
input,select{font-size:11px;padding:4px;width:100%;box-sizing:border-box}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
button{border:none;background:#2563eb;color:#fff;font-size:12px;padding:6px 12px;border-radius:6px;cursor:pointer}
button.secondary{background:#e2e8f0;color:#1e293b}
button.delete{background:#dc2626;color:white;padding:3px 8px;font-size:11px;border-radius:4px}
button.addrow{background:#16a34a;color:white;padding:3px 8px;font-size:11px;border-radius:4px;margin-left:3px}
button.edit{background:#f59e0b;color:white;padding:3px 8px;font-size:11px;border-radius:4px;margin-right:3px}
button:hover{opacity:.9}
.encabezado{font-size:11px;margin-bottom:8px;border:1px solid #ccc;padding:6px;border-radius:6px;background:#f8fafc}
.encabezado input{width:150px;margin-right:10px;padding:3px;font-size:11px}
.encabezado-pdf{display:none;margin-bottom:20px;font-size:12px}
.encabezado-pdf table{width:100%;border:none}
.encabezado-pdf td{border:none;vertical-align:top}
.encabezado-pdf .empresa{font-weight:bold;text-transform:uppercase}
.encabezado-pdf .titulo{text-align:center;font-weight:bold;font-size:13px}
.encabezado-pdf .fecha{text-align:right;font-size:11px}
@media print{
  button,.controls,.encabezado,.no-print,#colAccion{display:none!important}
  body{background:white}
  .card{box-shadow:none;border:none}
  .encabezado-pdf{display:block}
}

/* === ESTILOS LIBROS MAYORES === */
.mayores-section {
  margin-top: 20px;
}
.mayores-controls {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-bottom: 8px;
  justify-content: center;
}
.mayor-page {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
  padding: 6px;
  border-radius: 4px;
}
.mayor-card {
  flex: 1 1 calc(50% - 10px);
  min-width: 300px;
  border: 1px solid #e0e7ff;
  border-radius: 6px;
  background: #fff;
  padding: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,.05);
}
.mayor-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
  font-size: 12px;
}
.mayor-table {
  font-size: 11px;
  border-collapse: collapse;
  width: 100%;
}
.mayor-table th, .mayor-table td {
  border: 1px solid #e6e9ef;
  padding: 4px 6px;
  text-align: left;
}
.mayor-table th {
  background: #f9fafb;
}
.mayor-table td.right {
  text-align: right;
}
.mayor-total {
  text-align: right;
  font-weight: 700;
  padding-top: 4px;
  font-size: 12px;
}
@media print {
  body.printing-mayores * {
    visibility: hidden;
  }
  body.printing-mayores #mayoresCard,
  body.printing-mayores #mayoresCard * {
    visibility: visible;
  }
  #mayoresCard {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
  .mayor-page {
    page-break-after: always;
  }
}
</style>
</head>
<body>
<div class="card">

  <!-- Encabezado PDF -->
  <div class="encabezado-pdf" id="encabezadoPDF">
    <table>
      <tr>
        <td class="empresa" id="pdfRazon">RAZ√ìN SOCIAL</td>
        <td class="titulo" id="pdfTitulo">*** LIBRO DIARIO DEL MES DE ENERO ***</td>
        <td class="fecha" id="pdfFecha">10/11/2025</td>
      </tr>
      <tr><td>PERIODO <span id="pdfPeriodo">2025</span></td><td></td><td></td></tr>
      <tr><td id="pdfDireccion">DIRECCI√ìN</td><td></td><td></td></tr>
      <tr><td>R.U.C.: <span id="pdfRuc">00000000000</span></td><td></td><td></td></tr>
    </table>
  </div>

  <h2 class="no-print">üìò Libro Diario ‚Äì Formato SUNAT Inteligente</h2>

  <div class="encabezado">
    <label>RUC: <input type="text" id="ruc" placeholder="12345678901"></label>
    <label>Raz√≥n Social: <input type="text" id="razon" placeholder="Nombre de la empresa"></label>
    <label>Direcci√≥n: <input type="text" id="direccion" placeholder="Direcci√≥n fiscal"></label>
    <label>Periodo: <input type="text" id="periodo" placeholder="2025"></label>
    <label>Mes: <input type="text" id="mes" placeholder="Noviembre"></label>
  </div>

  <!-- Controles -->
  <div class="controls">
    <input type="date" id="fecha">
    <input type="text" id="glosa" placeholder="Glosa / Descripci√≥n">
    <input type="text" id="codigo" placeholder="C√≥digo (Ej. 10)">
    <input type="text" id="denom" placeholder="Denominaci√≥n de Cuenta" readonly>
    <select id="tipo">
      <option value="debe">D√©bito</option>
      <option value="haber">Cr√©dito</option>
    </select>
    <input type="number" step="0.01" id="monto" placeholder="Monto (S/.)">

    <button id="add">‚ûï Agregar Asiento</button>
    <button id="update" class="secondary" style="display:none;">üíæ Guardar cambios</button>
    <button id="clear" class="secondary">üßπ Limpiar</button>
    <button id="export" class="secondary">‚¨áÔ∏è CSV</button>
    <button id="import" class="secondary">üìÇ Importar</button>
    <input type="file" id="importFile" accept=".csv" style="display:none">
    <button id="print" class="secondary">üñ®Ô∏è PDF</button>
  </div>

  <!-- Tabla principal -->
  <table id="tabla">
    <thead>
      <tr>
        <th style="width:40px;">N¬∞</th>
        <th style="width:85px;">Fecha</th>
        <th style="width:200px;">Glosa / Descripci√≥n</th>
        <th style="width:80px;">C√≥digo</th>
        <th style="width:220px;">Denominaci√≥n de Cuenta</th>
        <th style="width:90px;" class="right">Debe</th>
        <th style="width:90px;" class="right">Haber</th>
        <th id="colAccion" style="width:130px;">Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="5" class="right">TOTAL</td>
        <td id="totalDebe" class="right">0.00</td>
        <td id="totalHaber" class="right">0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
// === VARIABLES GLOBALES ===
let asientos = [];
const tbody = document.querySelector("#tabla tbody");
const totalDebe = document.getElementById("totalDebe");
const totalHaber = document.getElementById("totalHaber");

// Cat√°logo de cuentas
const cuentas= {
  "10": "Efectivo y equivalentes de efectivo",
  "12": "Cuentas por cobrar comerciales ‚Äì Terceros",
  "13": "Cuentas por cobrar comerciales ‚Äì Relacionadas",
  "14": "Cuentas por cobrar al personal, accionistas y directores",
  "16": "Cuentas por cobrar diversas ‚Äì Terceros",
  "19": "Deterioro de cuentas por cobrar",
  "20": "Existencias",
  "21": "Productos terminados",
  "22": "Subproductos, desechos y desperdicios",
  "24": "Materias primas",
  "25": "Materiales auxiliares, suministros y repuestos",
  "30": "Inversiones mobiliarias",
  "31": "Inversiones inmobiliarias",
  "33": "Inmuebles, maquinaria y equipo",
  "34": "Intangibles",
  "35": "Activos biol√≥gicos",
  "37": "Activos por impuestos diferidos",
  "39": "Depreciaci√≥n, amortizaci√≥n y agotamiento acumulado",
  "40": "Tributos, contribuciones y aportes al sistema de pensiones y salud por pagar",
  "41": "Remuneraciones y participaciones por pagar",
  "42": "Cuentas por pagar comerciales ‚Äì Terceros",
  "43": "Cuentas por pagar comerciales ‚Äì Relacionadas",
  "44": "Cuentas por pagar a accionistas, directores y gerentes",
  "45": "Obligaciones financieras",
  "46": "Cuentas por pagar diversas ‚Äì Terceros",
  "47": "Cuentas por pagar diversas ‚Äì Relacionadas",
  "48": "Provisiones",
  "49": "Pasivos por impuestos diferidos",
  "50": "Capital",
  "52": "Resultados acumulados",
  "55": "Resultados del ejercicio",
  "57": "Ajustes de patrimonio",
  "60": "Compras",
  "61": "Variaci√≥n de existencias",
  "62": "Gastos de personal, directores y gerentes",
  "63": "Gastos por servicios prestados por terceros",
  "64": "Gastos por tributos",
  "65": "Otros gastos de gesti√≥n",
  "68": "Valuaci√≥n y deterioro de activos y provisiones",
  "69": "Costo de ventas",
  "70": "Ventas",
  "71": "Producci√≥n del ejercicio",
  "72": "Variaci√≥n de productos terminados",
  "73": "Descuentos, rebajas y bonificaciones otorgadas",
  "74": "Descuentos, rebajas y bonificaciones obtenidas",
  "75": "Otros ingresos de gesti√≥n",
  "76": "Ganancias por medici√≥n de activos y pasivos",
  "77": "Ingresos financieros",
  "78": "Diferencias de cambio",
  "79": "Cargas imputables a cuentas de costos",
  "80": "Margen comercial",
  "81": "Producci√≥n del ejercicio",
  "82": "Valor agregado",
  "83": "Excedente bruto de explotaci√≥n",
  "84": "Resultado antes de participaciones e impuestos",
  "85": "Resultado del ejercicio",
  "90": "Costos de producci√≥n",
  "91": "Costos indirectos",
  "92": "Gastos de administraci√≥n",
  "93": "Gastos de ventas",
  "94": "Gastos financieros",
  "95": "P√©rdida por medici√≥n de activos y pasivos",
  "96": "Resultados extraordinarios",
  "97": "Impuesto a la renta",
  "99": "Cuentas de orden"
};


// Renderizar tabla
function render(){
  tbody.innerHTML="";
  let sumDebe=0,sumHaber=0;
  asientos.forEach((a,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${a.fecha}</td>
      <td>${a.glosa}</td>
      <td>${a.codigo}</td>
      <td>${a.denom}</td>
      <td class="right">${a.debe?a.debe.toFixed(2):""}</td>
      <td class="right">${a.haber?a.haber.toFixed(2):""}</td>
      <td id="colAccion">
        <button class="edit" onclick="editarAsiento(${i})">‚úèÔ∏è</button>
        <button class="delete" onclick="eliminarAsiento(${i})">üóëÔ∏è</button>
        <button class="addrow" onclick="agregarFilaDespues(${i})">‚ûï</button>
      </td>`;
    tbody.appendChild(tr);
    sumDebe+=a.debe||0;
    sumHaber+=a.haber||0;
  });
  totalDebe.textContent=sumDebe.toFixed(2);
  totalHaber.textContent=sumHaber.toFixed(2);
}

// Autocompletar denominaci√≥n
document.getElementById("codigo").addEventListener("input", e=>{
  const cod=e.target.value.trim();
  document.getElementById("denom").value=cuentas[cod]||"";
});


// === CRUD de ASIENTOS ===

// AGREGAR ASIENTO
document.getElementById("add").addEventListener("click", () => {
  const fecha = fechaInput.value;
  const glosa = glosaInput.value.trim();
  const codigo = codigoInput.value.trim();
  const denom = denomInput.value.trim();
  const tipo = tipoInput.value;
  const monto = parseFloat(montoInput.value);

  if (!fecha || !glosa || !codigo || !denom || isNaN(monto)) {
    alert("‚ö†Ô∏è Complete todos los campos antes de agregar.");
    return;
  }

  asientos.push({
    fecha,
    glosa,
    codigo,
    denom,
    debe: tipo === "debe" ? monto : 0,
    haber: tipo === "haber" ? monto : 0
  });

  resetForm();
  render();
});

// ELIMINAR ASIENTO
function eliminarAsiento(i) {
  if (confirm("¬øEliminar este asiento?")) {
    asientos.splice(i, 1);
    render();
  }
}

// EDITAR ASIENTO
let editIndex = null;

function editarAsiento(i) {
  const a = asientos[i];
  editIndex = i;

  fechaInput.value = a.fecha;
  glosaInput.value = a.glosa;
  codigoInput.value = a.codigo;
  denomInput.value = a.denom;
  montoInput.value = a.debe ? a.debe : a.haber;
  tipoInput.value = a.debe ? "debe" : "haber";

  document.getElementById("add").style.display = "none";
  document.getElementById("update").style.display = "inline-block";
}

// GUARDAR CAMBIOS
document.getElementById("update").addEventListener("click", () => {
  if (editIndex === null) return;

  const fecha = fechaInput.value;
  const glosa = glosaInput.value.trim();
  const codigo = codigoInput.value.trim();
  const denom = denomInput.value.trim();
  const tipo = tipoInput.value;
  const monto = parseFloat(montoInput.value);

  asientos[editIndex] = {
    fecha,
    glosa,
    codigo,
    denom,
    debe: tipo === "debe" ? monto : 0,
    haber: tipo === "haber" ? monto : 0
  };

  editIndex = null;
  resetForm();
  render();

  document.getElementById("add").style.display = "inline-block";
  document.getElementById("update").style.display = "none";
});

// INSERTAR FILA DESPU√âS
function agregarFilaDespues(i) {
  const fecha = fechaInput.value || "";
  asientos.splice(i + 1, 0, {
    fecha: "",
    glosa: "",
    codigo: "",
    denom: "",
    debe: 0,
    haber: 0
  });
  render();
}

// LIMPIAR FORMULARIO
function resetForm() {
  fechaInput.value = "";
  glosaInput.value = "";
  codigoInput.value = "";
  denomInput.value = "";
  montoInput.value = "";
  tipoInput.value = "debe";

  document.getElementById("add").style.display = "inline-block";
  document.getElementById("update").style.display = "none";
}

document.getElementById("clear").addEventListener("click", resetForm);

// INPUTS
const fechaInput = document.getElementById("fecha");
const glosaInput = document.getElementById("glosa");
const codigoInput = document.getElementById("codigo");
const denomInput = document.getElementById("denom");
const tipoInput = document.getElementById("tipo");
const montoInput = document.getElementById("monto");


// EXPORTAR CSV
document.getElementById("export").addEventListener("click",()=>{/* ... */});

// ‚úÖ IMPORTAR CSV (reparado)
document.getElementById("import").addEventListener("click",()=>document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const lines=evt.target.result.split(/\r?\n/).filter(l=>l.trim()!=="");
    if(lines.length<=1)return alert("El archivo CSV est√° vac√≠o o sin formato v√°lido.");
    const [headerLine,...rows]=lines;
    asientos=[];
    rows.forEach(line=>{
      const cols=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"").trim());
      const [fecha,glosa,codigo,denom,debe,haber]=cols;
      if(fecha&&codigo){
        asientos.push({
          fecha,glosa,codigo,denom,
          debe:parseFloat(debe)||0,
          haber:parseFloat(haber)||0
        });
      }
    });
    render();
    alert("‚úÖ Asientos importados correctamente.");
  };
  reader.readAsText(file,"UTF-8");
});

// === PDF LIBRO DIARIO PROFESIONAL ===
document.getElementById("print").addEventListener("click", () => {
  const razon = document.getElementById("razon").value || "RAZ√ìN SOCIAL";
  const periodo = document.getElementById("periodo").value || "2025";
  const direccion = document.getElementById("direccion").value || "DIRECCI√ìN";
  const mes = document.getElementById("mes").value || "MES";
  const ruc = document.getElementById("ruc").value || "00000000000";
  const fechaHoy = new Date().toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"});
  // üîß Actualizar datos del encabezado PDF antes de imprimir
  document.getElementById("pdfRazon").textContent = razon.toUpperCase();
  document.getElementById("pdfRuc").textContent = ruc;
  document.getElementById("pdfDireccion").textContent = direccion;
  document.getElementById("pdfPeriodo").textContent = periodo;
  document.getElementById("pdfTitulo").textContent = `*** LIBRO DIARIO DEL MES DE ${mes.toUpperCase()} ***`;
  document.getElementById("pdfFecha").textContent = fechaHoy;

  // Clonar encabezado PDF
  const encabezadoClone = document.getElementById("encabezadoPDF").cloneNode(true);
  encabezadoClone.style.display = "block";

  // Clonar tabla
  const tablaClone = document.getElementById("tabla").cloneNode(true);

  // Eliminar columna de acci√≥n
  tablaClone.querySelectorAll('th:last-child, td:last-child').forEach(el => el.remove());

  // Crear contenedor temporal para imprimir
  const printContainer = document.createElement("div");
  printContainer.appendChild(encabezadoClone);
  printContainer.appendChild(tablaClone);

  // Abrir ventana de impresi√≥n
  const ventanaPrint = window.open("", "_blank");
  ventanaPrint.document.write("<html><head><title>Libro Diario</title>");
  
  // Estilos
  ventanaPrint.document.write(`
    <style>
      body{font-family:Arial,sans-serif; margin:20px;}
      h2{text-align:center; margin-bottom:10px;}
      table{border-collapse:collapse; width:100%; font-size:12px; page-break-inside:auto;}
      thead{display:table-header-group;}
      tfoot{display:table-footer-group;}
      th,td{border:1px solid #000; padding:4px;}
      th{background:#f0f0f0; font-weight:bold; text-align:center;}
      td.right{text-align:right;}
      .encabezado-pdf{margin-bottom:10px; font-size:12px;}
      .encabezado-pdf table{width:100%; border:none;}
      .encabezado-pdf td{border:none; vertical-align:top;}
      .empresa{font-weight:bold; text-transform:uppercase;}
      .titulo{text-align:center; font-weight:bold; font-size:13px;}
      .fecha{text-align:right; font-size:11px;}
      @media print{
        body{margin:0;}
        table, tr, td, th {page-break-inside: avoid;}
      }
    </style>
  `);

  ventanaPrint.document.write("</head><body>");
  ventanaPrint.document.write(printContainer.innerHTML);
  ventanaPrint.document.write("</body></html>");
  ventanaPrint.document.close();
  ventanaPrint.focus();
  ventanaPrint.print();
});


// === BLOQUE DE LIBROS MAYORES ===
document.addEventListener("DOMContentLoaded", () => {
  const btnGenMayores = document.createElement("button");
  const btnPrintMayores = document.createElement("button");
  btnGenMayores.textContent = "üìò Generar Libros Mayores";
  btnPrintMayores.textContent = "üñ®Ô∏è Descargar PDF";
  btnGenMayores.className = "secondary";
  btnPrintMayores.className = "secondary";

  const contenedor = document.createElement("div");
  contenedor.className = "card mayores-section";
  contenedor.id = "mayoresCard";
  contenedor.innerHTML = `
    <h2>üìò Libros Mayores</h2>
    <div class="mayores-controls"></div>
    <div class="encabezado" id="mayoresEncabezado" 
         style="justify-content:space-between;font-weight:600;text-align:center;font-size:12px">
      <div id="m_pdfRazon">RAZ√ìN SOCIAL</div>
      <div>LIBROS MAYORES<br>Periodo: <span id="m_pdfPeriodo">2025</span> - Mes: <span id="m_pdfMes">Noviembre</span></div>
      <div>RUC: <span id="m_pdfRuc">00000000000</span></div>
    </div>
    <div id="mayoresContainer" class="mayores-wrapper"></div>
  `;
  contenedor.querySelector(".mayores-controls").appendChild(btnGenMayores);
  contenedor.querySelector(".mayores-controls").appendChild(btnPrintMayores);
  document.body.appendChild(contenedor);

  btnGenMayores.addEventListener("click", () => {
    const container = document.getElementById("mayoresContainer");
    container.innerHTML = "";
    if (!asientos.length) { container.innerHTML = "<p>No hay asientos registrados.</p>"; return; }

    document.getElementById("m_pdfRazon").textContent = (document.getElementById("razon").value || "RAZ√ìN SOCIAL").toUpperCase();
    document.getElementById("m_pdfRuc").textContent = document.getElementById("ruc").value || "00000000000";
    document.getElementById("m_pdfPeriodo").textContent = document.getElementById("periodo").value || "2025";
    document.getElementById("m_pdfMes").textContent = document.getElementById("mes").value || "MES";

    const grupos = {};
    asientos.forEach(a => { const c = a.codigo.slice(0,2); if(!grupos[c]) grupos[c]=[]; grupos[c].push(a); });

    const codigos = Object.keys(grupos).sort((a,b)=>+a-+b);
    let current=null, count=0;

    codigos.forEach(code=>{
      if(count===0){ current=document.createElement("div"); current.className="mayor-page"; container.appendChild(current); }
      const movs=grupos[code];
      movs.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
      let saldo=0, rows="";
      movs.forEach(m=>{
        const d=+m.debe||0,h=+m.haber||0;
        saldo+=d-h;
        rows+=`<tr>
          <td>${m.fecha}</td>
          <td>${m.glosa}</td>
          <td class='right'>${d?d.toFixed(2):""}</td>
          <td class='right'>${h?h.toFixed(2):""}</td>
          <td class='right'>${saldo.toFixed(2)}</td>
        </tr>`;
      });
      const card=document.createElement("div");
      card.className="mayor-card";
      card.innerHTML=`
        <div class='mayor-header'>
          <div><b>${cuentas[code]||"Cuenta "+code}</b> (${code})</div>
          <div>Saldo final: ${saldo.toFixed(2)}</div>
        </div>
        <table class='mayor-table'>
          <thead><tr><th>Fecha</th><th>Glosa</th><th>Debe</th><th>Haber</th><th>Saldo</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      current.appendChild(card);
      count++; if(count>=2) count=0;
    });
  });

  btnPrintMayores.addEventListener("click", ()=>{
    const printContent = document.getElementById("mayoresCard").innerHTML;
    const ventanaPrint = window.open("","_blank");
    ventanaPrint.document.write("<html><head><title>Libros Mayores</title>");
    ventanaPrint.document.write("<style>body{font-family:Arial,sans-serif;margin:20px;} table{border-collapse:collapse;width:100%;font-size:12px;} th,td{border:1px solid #000;padding:4px;} th{background:#f0f0f0;} td.right{text-align:right;} .mayor-page{page-break-after:always;} </style>");
    ventanaPrint.document.write("</head><body>");
    ventanaPrint.document.write(printContent);
    ventanaPrint.document.write("</body></html>");
    ventanaPrint.document.close();
    ventanaPrint.focus();
    ventanaPrint.print();
  });
});
</script>
</body>
</html>
